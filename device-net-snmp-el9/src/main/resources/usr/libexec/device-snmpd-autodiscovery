#!/bin/bash

#
# Net SNMP Server Autodiscovery
# =============================
#
# This script autogenerates the snmpd config.

set -e
umask 0007


#
# Handle the cleanup
# ------------------
cleanup_before_exit () {
  if [ -d "${tmpdir}" ]; then
    rm -rf "${tmpdir}"
  fi
}
# be in a temporay workspace (this works on linux and macosx)
tmpdir=`mktemp -d 2>/dev/null || mktemp -d -t 'tmpdir'`
# trap catches the exit signal and runs the specified function
trap cleanup_before_exit EXIT
# be in our directory
cd "${tmpdir}"


#
# Generate Config
# ---------------
#

  cat >> "snmpd.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

dontLogTCPWrappersConnects yes
includeAllDisks 10%
tsmUseTransportPrefix yes

EOF

syslocation=""
if [ -f "/etc/device/services/snmp/location.txt" ]; then
  syslocation=$(head -n 1 /etc/device/services/snmp/location.txt)

  cat >> "snmpd.conf" <<- EOF
# Note: syslocation from /etc/device/services/snmp/location.txt
syslocation ${syslocation}
EOF

fi

syscontact=""
if [ -f "/etc/device/services/snmp/contact.txt" ]; then
  syscontact=$(head -n 1 /etc/device/services/snmp/contact.txt)

  cat >> "snmpd.conf" <<- EOF
# Note: syslocation from /etc/device/services/snmp/contact.txt
syscontact ${syscontact}
EOF

fi

if [ -f "/etc/device/services/snmp-server/engine-id.txt" ]; then
  engineid=$(head -n 1 /etc/device/services/snmp/engine-id.txt)
  cat >> "snmpd.conf" <<- EOF
# Note: engineID from /etc/device/services/snmp/engine-id.txt
engineID ${engineid}
EOF
fi


#
# Reset Users
# -----------
#

if [ -e /var/lib/net-snmp/snmpd.conf ]; then
  logger -t "${0}" "Notice: Removing users from net-snmp snmpd.conf..."
  users_conf=`umask 0022; mktemp /var/lib/net-snmp/snmpd.conf.XXXXXX`
  cat /var/lib/net-snmp/snmpd.conf | grep -v -e "^usmUser " | grep -v -e "^createUser " > ${users_conf}
  mv ${users_conf} /var/lib/net-snmp/snmpd.conf
fi




#
# Handle scripts
# --------------
#

find "$0.d" -type f -executable | sort | \
while read x; do
  "$x" "${1}" < /dev/null || touch error;
done


#
# Switch config into place
# ------------------------
#

mv "snmpd.conf" "/etc/snmp/snmpd.conf"


